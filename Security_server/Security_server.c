/*
 * Copyright (c) 2020 Nanjing Xiaoxiongpai Intelligent Technology Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

#include <stdio.h>
#include <unistd.h>
#include <ctype.h>

#include "ohos_init.h"
#include "cmsis_os2.h"

#include "lwip/sockets.h"
#include <string.h>
#include <ssd1306_tests.h>
#include "DHT11.h"
#include "sensor.h"
#include "wifi_connect.h"
#include "wifi_device.h"
#include "wifi_hotspot.h"
#include "wifi_error_code.h"
#include "lwip/netifapi.h"
#include "ssd1306.h"
#include "wifiiot_gpio.h"
#include "wifiiot_gpio_ex.h"
#include "wifiiot_pwm.h"
#include "wifiiot_adc.h"
#include "wifiiot_i2c.h"
#include "wifiiot_errno.h"
#include "wifiiot_watchdog.h"
#include "wifiiot_uart.h"
#include "wifiiot_errno.h"

#define UART_TASK_STACK_SIZE 1024 * 8
#define UART_TASK_PRIO 25
#define UART_BUFF_SIZE 1000
#define OLED_I2C_BAUDRATE 400*1000
#define AP_SSID "BearPi"
#define AP_PSK  "0987654321"
#define _PROT_ 1111
#define TCP_BACKLOG 10

static void OnHotspotStaJoinHandler(StationInfo *info);
static void OnHotspotStateChangedHandler(int state);
static void OnHotspotStaLeaveHandler(StationInfo *info);
static void TcpClientTask(void);
static void TcpClientHandler(void);
static void SensorTask(void);
static void SensorHandler(void);
/*static void StaTask(void);
static void StaHandler(void);*/

//在sock_fd 进行监听，在 new_fd 接收新的链接
int sock_fd, new_fd[10];	//客户端地址信息
struct sockaddr_in client_sock[10];
int flag = 0;
int Humidity,Temperature;
int device_no = 0;
char uart_buff[UART_BUFF_SIZE] = {0xC7,0xEB,0xD5,0xFD,0xC8,0xB7,0xC5,0xE5,0xB4,0xF7};
uint32_t uart_ret;
struct sockaddr_in *cli_addr[10];
int client_no = 0;
char recvbuf[10][512];
static struct netif *g_lwip_netif = NULL;
static int g_apEnableSuccess = 0;
WifiEvent g_wifiEventHandler = {0};
WifiErrorCode error;
char uart_CO[] = {0xB5,0xB1,0xC7,0xB0 ,0xBC,0xD7 ,0xCD,0xE9 ,0xC5,0xA8 ,0xB6,0xC8 ,0xB3,0xAC ,0xB1,0xEA ,0xA3,0xAC ,0xC7,0xEB ,0xBE,0xA1 ,0xBF,0xEC ,0xB3,0xB7,0xC0,0xEB };
const uint8_t  Normal_image[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x01,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xE0,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,
0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x60,0x00,0x00,0x00,0x00,0x00,0x00,
0x06,0x00,0x00,0x00,0xC0,0x00,0x00,0x08,0x00,0x60,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x03,0xF0,0x00,0x00,0x0C,0x0E,0xE6,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0xFE,0x1F,0xC0,0x00,0x04,0x04,0x62,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0xF8,0x07,0xC0,0x00,0x04,0x02,0x04,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x80,0x00,0x60,0x00,0x04,0x01,0x68,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x01,0x80,0x00,0x60,0x00,0x04,0x00,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x01,0x80,0x00,0x60,0x00,0x04,0x00,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x01,0x80,0x00,0x60,0x00,0x04,0x03,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x01,0x80,0x06,0x20,0x00,0x04,0x03,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x01,0x80,0x0C,0x60,0x00,0x04,0x07,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x01,0x80,0x18,0x60,0x00,0x04,0x07,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x01,0x8C,0x30,0x60,0x00,0x04,0x07,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x8E,0x60,0x60,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x87,0xC0,0x60,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0xC1,0x80,0x40,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0xC0,0x00,0xC0,0x00,0x04,0x00,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x40,0x00,0xC0,0x00,0x04,0x01,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x60,0x01,0x80,0x00,0x04,0x01,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x30,0x03,0x00,0x00,0x04,0x03,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x1C,0x0E,0x00,0x00,0x04,0x07,0x77,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x07,0x3C,0x00,0x00,0x04,0x0E,0xBB,0x80,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x01,0xF0,0x00,0x00,0x08,0x0E,0xDB,0x80,0x00,0x00,0x00,0x00,0x00,
0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x0E,0x27,0x00,0x00,0x00,0x00,0x00,0x00,
0x01,0x80,0x00,0x00,0x00,0x00,0x00,0x30,0x07,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0x03,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x60,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x7F,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,0x60,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x40,0x30,0x00,0x00,0x00,0x00,0x00,0x00,0x50,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x48,0x30,0x00,0x00,0x00,0x00,0x00,0x07,0xD8,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x40,0x30,0x00,0x00,0x00,0x00,0x00,0x0A,0x68,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x7F,0xF0,0x00,0x00,0x00,0x00,0x00,0x19,0xE8,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x3F,0xBF,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0xE2,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0xFF,0xF0,0x00,0x00,0x00,0x00,0x00,0x03,0xD6,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0xC2,0x10,0x00,0x00,0x00,0x00,0x00,0x03,0x4C,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0xC2,0x10,0x00,0x00,0x00,0x00,0x00,0x02,0x40,0x00,0x00,0x00,0x00,0x00,0x00,
0x01,0xE7,0x38,0x00,0x00,0x00,0x00,0x00,0x01,0x40,0x00,0x00,0x00,0x00,0x00,0x00,
0x01,0x25,0x28,0x00,0x00,0x00,0x00,0x00,0x01,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,
0x01,0xE7,0x38,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};//正常样式图案

const unsigned char Normal_Size[] = { 128, 57 ,128};//正常图案尺寸

const uint8_t  Wind_low_image[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x01,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x80,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x01,0x00,0x00,0x00,0x20,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x01,0x80,0x00,0x00,0x20,0x37,0x70,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x01,0xC0,0x00,0x00,0x20,0x20,0x20,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x01,0x60,0x00,0x00,0x20,0x12,0x40,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x01,0x30,0x00,0x00,0x20,0x0A,0x80,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x01,0x18,0x00,0x00,0x20,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x3F,0x18,0x00,0x00,0x20,0x0F,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0xC9,0x68,0x00,0x00,0x20,0x1F,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x8D,0xC8,0x00,0x00,0x20,0x3F,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x01,0x07,0xC8,0x00,0x00,0x20,0x3F,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x07,0xFE,0x7F,0xC0,0x00,0x20,0x3F,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x13,0xC1,0x80,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x17,0x23,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x1D,0x16,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x19,0xFC,0x00,0x00,0x20,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x11,0x00,0x00,0x00,0x20,0x0F,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x09,0x00,0x00,0x00,0x20,0x1F,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x05,0x00,0x00,0x00,0x20,0x3F,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x03,0x00,0x00,0x00,0x20,0x73,0x38,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x01,0x00,0x00,0x00,0x20,0x76,0xD8,0x00,0x00,0x00,0x00,0x00,0x00,
0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x74,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x3B,0x30,0x00,0x00,0x00,0x00,0x00,0x00,
0x01,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x80,0x1F,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x80,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x7F,0xE0,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x40,0x20,0x00,0x00,0x00,0x00,0x00,0x02,0x80,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x50,0x20,0x00,0x00,0x00,0x00,0x00,0x1E,0x80,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x40,0x20,0x00,0x00,0x00,0x00,0x00,0x33,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x7F,0xE0,0x00,0x00,0x00,0x00,0x00,0x4E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x77,0xC0,0x00,0x00,0x00,0x00,0x00,0xFD,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x17,0x10,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0xFF,0xE0,0x00,0x00,0x00,0x00,0x00,0x1F,0xA0,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x84,0x20,0x00,0x00,0x00,0x00,0x00,0x1A,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x84,0x20,0x00,0x00,0x00,0x00,0x00,0x12,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x01,0xCE,0x70,0x00,0x00,0x00,0x00,0x00,0x0A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x01,0x4A,0x50,0x00,0x00,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x01,0xCE,0x70,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

const unsigned char Wind_low_Size[] = { 128, 55 ,128};//低通风量图案尺寸

const uint8_t  CO_high_image[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x3F,0xFF,0xFF,0xFF,0xFF,0xFF,0xE0,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0xC0,0x00,0x00,0x00,0x00,0x00,0x18,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,
0x01,0x00,0x00,0x00,0x40,0x00,0x00,0x04,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x00,0x01,0xF0,0x00,0x00,0x02,0x00,0x38,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x00,0x03,0xF8,0x00,0x00,0x02,0x03,0x33,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x00,0x07,0xFC,0x00,0x00,0x02,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x00,0x0F,0xFE,0x00,0x00,0x02,0x00,0xB0,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x00,0x1F,0xFF,0x00,0x00,0x02,0x00,0x74,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x00,0x3F,0xFF,0x80,0x00,0x02,0x00,0x38,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x00,0x7F,0xFF,0xC0,0x00,0x02,0x00,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x00,0xFC,0xF3,0xE0,0x00,0x02,0x01,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x01,0xFA,0x61,0xF0,0x00,0x02,0x03,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x03,0xF7,0xCE,0xF8,0x00,0x02,0x03,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x03,0xF7,0xDE,0xF8,0x00,0x02,0x03,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x03,0xF7,0x5E,0xF8,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x01,0xFA,0x6D,0xF0,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x00,0xFC,0xF3,0xF0,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x00,0x7F,0xFF,0xE0,0x00,0x02,0x00,0x38,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x00,0x3F,0xFF,0xC0,0x00,0x02,0x00,0x7C,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x00,0x1F,0xFF,0x00,0x00,0x02,0x00,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x00,0x0F,0xFE,0x00,0x00,0x02,0x01,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x00,0x07,0xFE,0x00,0x00,0x02,0x03,0xFF,0x80,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x00,0x03,0xFC,0x00,0x00,0x02,0x07,0x55,0xC0,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x00,0x01,0xF8,0x00,0x00,0x02,0x07,0x75,0xC0,0x00,0x00,0x00,0x00,0x00,
0x01,0x00,0x00,0x00,0xE0,0x00,0x00,0x04,0x07,0x55,0xC0,0x00,0x00,0x00,0x00,0x00,
0x01,0x80,0x00,0x00,0x00,0x00,0x00,0x0C,0x03,0xFF,0x80,0x00,0x00,0x00,0x00,0x00,
0x00,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xF0,0x01,0xFF,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7C,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x38,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x3F,0xF8,0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x30,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x28,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x34,0x08,0x00,0x00,0x00,0x00,0x00,0x01,0xE4,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x34,0x08,0x00,0x00,0x00,0x00,0x00,0x03,0x2C,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x20,0x08,0x00,0x00,0x00,0x00,0x00,0x04,0xB4,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x3F,0xF8,0x00,0x00,0x00,0x00,0x00,0x08,0x74,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0xDF,0x80,0x00,0x00,0x00,0x00,0x00,
0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x69,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x3F,0xF8,0x00,0x00,0x00,0x00,0x00,0x01,0xA6,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x21,0x08,0x00,0x00,0x00,0x00,0x00,0x01,0x3C,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0xF3,0x9E,0x00,0x00,0x00,0x00,0x00,0x00,0xA0,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0xD2,0x96,0x00,0x00,0x00,0x00,0x00,0x00,0x60,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0xD3,0x96,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0xF3,0x9E,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

const unsigned char CO_high_Size[] = { 128, 57 ,128};//高一氧化碳图案尺寸

const uint8_t  Gas_high_image[] = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x03,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x06,0x00,0x00,0x00,0x00,0x00,0x01,0x80,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x08,0x00,0x00,0x06,0x00,0x00,0x00,0x80,0x0E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x08,0x00,0x00,0x03,0x00,0x00,0x00,0x40,0x0E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x08,0x00,0x00,0x03,0x00,0x00,0x00,0x40,0x4C,0x40,0x00,0x00,0x00,0x00,0x00,0x00,
0x08,0x00,0x00,0x07,0x80,0x00,0x00,0x40,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,
0x08,0x00,0x00,0x07,0x80,0x00,0x00,0x40,0x25,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x08,0x00,0x00,0x0F,0x80,0x00,0x00,0x40,0x1E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x08,0x00,0x03,0xC7,0x9F,0x00,0x00,0x40,0x0E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x08,0x00,0x01,0x87,0x06,0x00,0x00,0x40,0x3F,0x80,0x00,0x00,0x00,0x00,0x00,0x00,
0x08,0x00,0x00,0x80,0x0C,0x00,0x00,0x40,0x7F,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,
0x08,0x00,0x00,0x47,0x18,0x00,0x00,0x40,0x7F,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,
0x08,0x00,0x00,0x27,0x30,0x00,0x00,0x40,0x7F,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,
0x08,0x00,0x00,0x1F,0x60,0x00,0x00,0x40,0x7F,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,
0x08,0x00,0x00,0x0F,0xC0,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x08,0x00,0x00,0x0F,0xC0,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x08,0x00,0x00,0x3F,0xF0,0x00,0x00,0x40,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x08,0x00,0x00,0x7F,0xF8,0x00,0x00,0x40,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x08,0x00,0x00,0xFF,0xFC,0x00,0x00,0x40,0x1F,0x80,0x00,0x00,0x00,0x00,0x00,0x00,
0x08,0x00,0x01,0xFF,0xFC,0x00,0x00,0x40,0x3F,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,
0x08,0x00,0x01,0xFF,0xFE,0x00,0x00,0x40,0x7F,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,
0x08,0x00,0x03,0xFF,0xFE,0x00,0x00,0x40,0xED,0x70,0x00,0x00,0x00,0x00,0x00,0x00,
0x08,0x00,0x03,0xFF,0xFE,0x00,0x00,0x41,0xDD,0xF0,0x00,0x00,0x00,0x00,0x00,0x00,
0x08,0x00,0x03,0xFF,0xFE,0x00,0x00,0x80,0xE5,0x60,0x00,0x00,0x00,0x00,0x00,0x00,
0x06,0x00,0x00,0x00,0x00,0x00,0x01,0x80,0x7F,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,
0x03,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0x00,0x3F,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x1F,0x80,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x06,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0C,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0xFF,0xC0,0x00,0x00,0x00,0x00,0x00,0x0A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x80,0x40,0x00,0x00,0x00,0x00,0x00,0x09,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0xA0,0x40,0x00,0x00,0x00,0x00,0x00,0x79,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x80,0x40,0x00,0x00,0x00,0x00,0x00,0xAB,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0xFF,0xC0,0x00,0x00,0x00,0x00,0x01,0x1D,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x08,0x00,0x00,0x00,0x00,0x00,0x03,0xF7,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x0E,0x40,0x00,0x00,0x00,0x00,0x00,0x00,
0x01,0xFF,0xC0,0x00,0x00,0x00,0x00,0x00,0x19,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,
0x01,0x08,0x40,0x00,0x00,0x00,0x00,0x00,0x2F,0x80,0x00,0x00,0x00,0x00,0x00,0x00,
0x03,0x9C,0xE0,0x00,0x00,0x00,0x00,0x00,0x28,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x94,0xA0,0x00,0x00,0x00,0x00,0x00,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x94,0xA0,0x00,0x00,0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x03,0x9C,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

const unsigned char Gas_high_Size[] = { 128, 55 ,128};//高一氧化碳图案尺寸

static void TCPServerTask(void)
{

    WifiIotUartAttribute uart_attr = {

        //baud_rate: 9600
        .baudRate = 9600,

        //data_bits: 8bits
        .dataBits = 8,
        .stopBits = 1,
        .parity = 0,
    };
    uart_ret = UartInit(WIFI_IOT_UART_IDX_1, &uart_attr, NULL);
    if (uart_ret != WIFI_IOT_SUCCESS)
    {
        printf("Failed to init uart! Err code = %d\n", uart_ret);
        return;
    }
    IoSetFunc(WIFI_IOT_IO_NAME_GPIO_13, WIFI_IOT_IO_FUNC_GPIO_13_I2C0_SDA);
    IoSetFunc(WIFI_IOT_IO_NAME_GPIO_14, WIFI_IOT_IO_FUNC_GPIO_14_I2C0_SCL);
    I2cInit(WIFI_IOT_I2C_IDX_0, OLED_I2C_BAUDRATE);
    WatchDogDisable();
    usleep(20*1000);
    ssd1306_Init();
    ssd1306_Fill(Black);
    SensorHandler();

    int ap_fd;
    int addr_length;
    struct sockaddr_in send_addr;
    addr_length = sizeof(send_addr);
    WifiConnect("BearPi", "0987654321");
    if ((ap_fd = socket(AF_INET, SOCK_STREAM, 0)) == -1)
    {
        perror("create socket failed!\r\n");
        exit(1);
    }

    //初始化预连接的服务端地址
    send_addr.sin_family = AF_INET;
    send_addr.sin_port = htons(_PROT_);
    send_addr.sin_addr.s_addr = inet_addr("192.168.1.1");
    addr_length = sizeof(send_addr);
    connect(ap_fd,(struct sockaddr *)&send_addr, addr_length);
	g_wifiEventHandler.OnHotspotStaJoin = OnHotspotStaJoinHandler;
    g_wifiEventHandler.OnHotspotStaLeave = OnHotspotStaLeaveHandler;
    g_wifiEventHandler.OnHotspotStateChanged = OnHotspotStateChangedHandler;
    error = RegisterWifiEvent(&g_wifiEventHandler);
    if (error != WIFI_SUCCESS)
    {
        printf("RegisterWifiEvent failed, error = %d.\r\n",error);
		exit(1);
    }
    printf("RegisterWifiEvent succeed!\r\n");
	HotspotConfig config = {0};

    strcpy(config.ssid, AP_SSID);
    strcpy(config.preSharedKey, AP_PSK);
    config.securityType = WIFI_SEC_TYPE_PSK;
    config.band = HOTSPOT_BAND_TYPE_2G;
    config.channelNum = 7;

    error = SetHotspotConfig(&config);
    if (error != WIFI_SUCCESS)
    {
        printf("SetHotspotConfig failed, error = %d.\r\n", error);
        exit(1);
    }
    printf("SetHotspotConfig succeed!\r\n");

    //启动wifi热点模式
    error = EnableHotspot(); 
    if (error != WIFI_SUCCESS)
    {
        printf("EnableHotspot failed, error = %d.\r\n", error);
        exit(1);
    }
    printf("EnableHotspot succeed!\r\n");

    //检查热点模式是否使能
    if (IsHotspotActive() == WIFI_HOTSPOT_NOT_ACTIVE)
    {
        printf("Wifi station is not actived.\r\n");
        exit(1);
    }
    printf("Wifi station is actived!\r\n");

    //启动dhcp
    g_lwip_netif = netifapi_netif_find("ap0");
    if (g_lwip_netif) 
    {
        ip4_addr_t bp_gw;
        ip4_addr_t bp_ipaddr;
        ip4_addr_t bp_netmask;

        IP4_ADDR(&bp_gw, 192, 168, 1, 1);           /* input your gateway for example: 192.168.1.1 */
        IP4_ADDR(&bp_ipaddr, 192, 168, 1, 1);       /* input your IP for example: 192.168.1.1 */
        IP4_ADDR(&bp_netmask, 255, 255, 255, 0);    /* input your netmask for example: 255.255.255.0 */

        err_t ret = netifapi_netif_set_addr(g_lwip_netif, &bp_ipaddr, &bp_netmask, &bp_gw);
        if(ret != ERR_OK)
        {
            printf("netifapi_netif_set_addr failed, error = %d.\r\n", ret);
            exit(1);
        }
        printf("netifapi_netif_set_addr succeed!\r\n");

        ret = netifapi_dhcps_start(g_lwip_netif, 0, 0);
        if(ret != ERR_OK)
        { 
            printf("netifapi_dhcp_start failed, error = %d.\r\n", ret);
            exit(1);
        }
        printf("netifapi_dhcps_start succeed!\r\n");

    }

	//服务端地址信息
	struct sockaddr_in server_sock;
    int sin_size;

	//创建socket
	if ((sock_fd = socket(AF_INET, SOCK_STREAM, 0)) == -1)
	{
		perror("socket is error\r\n");
		exit(1);
	}

	bzero(&server_sock, sizeof(server_sock));
	server_sock.sin_family = AF_INET;
	server_sock.sin_addr.s_addr = htonl(INADDR_ANY);
	server_sock.sin_port = htons(_PROT_);

	//调用bind函数绑定socket和地址
	if (bind(sock_fd, (struct sockaddr *)&server_sock, sizeof(struct sockaddr)) == -1)
	{
		perror("bind is error\r\n");
		exit(1);
	}

	//调用listen函数监听(指定port监听)
	if (listen(sock_fd, TCP_BACKLOG) == -1)
	{
		perror("listen is error\r\n");
		exit(1);
	}

	printf("start accept\n");
	//调用accept函数从队列中
	while (1)
	{
		sin_size = sizeof(struct sockaddr_in);

		if ((new_fd[client_no] = accept(sock_fd, (struct sockaddr *)&client_sock[client_no], (socklen_t *)&sin_size)) == -1)
		{
			perror("accept");
			continue;
		}
		cli_addr[client_no] = malloc(sizeof(struct sockaddr));
		printf("accept addr\r\n");

		if (cli_addr != NULL)
		{
			memcpy(cli_addr[client_no], &client_sock[client_no], sizeof(struct sockaddr));
		}
        client_no++; 

        TcpClientHandler();//服务器端多对一处理函数
	}
}

static void SensorTask(void)
{
    float mq5 = 0,mq7 = 0,wind=0;
    char data_str[20] = {0};
    while(1)
    {
        DHT11ReadData(&Humidity, &Temperature);
        printf("H:%d,T:%d",Humidity, Temperature);
        mq5 = GetMQ_5_Voltage();
        mq7 = GetMQ_7_Voltage();
        wind = GetwindVoltage();
        printf("mq5:%f,mq7:%f\n",mq5, mq7);
        sleep(1);
        //UartWrite(WIFI_IOT_UART_IDX_1, (unsigned char *)uart_buff, strlen(uart_buff)); 
        if(flag==0)
        {
        ssd1306_SetCursor(0, 0);
        ssd1306_DrawRegion(0, 0, Normal_Size[0], Normal_Size[1], Normal_image, sizeof(Normal_image), Normal_Size[2]);
        }
        else if(flag==1)
        {
        ssd1306_SetCursor(0, 0);
        ssd1306_DrawRegion(0, 0, CO_high_Size[0], CO_high_Size[1], CO_high_image, sizeof(CO_high_image), CO_high_Size[2]);            
        }
        ssd1306_SetCursor(90, 8);
        sprintf(data_str,"%d ppm",(int)mq5);
        ssd1306_DrawString(data_str, Font_6x8, White);
        sprintf(data_str,"%d ppm",(int)mq7);
        ssd1306_SetCursor(90, 25);
        ssd1306_DrawString(data_str, Font_6x8, White);
        sprintf(data_str,"%d m/s",(int)wind);
        ssd1306_SetCursor(90, 40);
        ssd1306_DrawString(data_str, Font_6x8, White);
        ssd1306_SetCursor(30, 40);
        sprintf(data_str,"%d",device_no);
        ssd1306_DrawString(data_str, Font_6x8, White);
        ssd1306_UpdateScreen();
        sleep(1);        
        //ssd1306_TestLine();
    }
}

static void SensorHandler(void)
{
    osThreadAttr_t attr;
    attr.name = "SensorTask";
    attr.attr_bits = 0U;
    attr.cb_mem = NULL;
    attr.cb_size = 0U;
    attr.stack_mem = NULL;
    attr.stack_size = 2048;
    attr.priority = 26;
    if (osThreadNew((osThreadFunc_t)SensorTask, NULL, &attr) == NULL) {
        printf("Sensor:create task fail!\r\n");
    }
}

/*static void StaTask(void)
{
    

        //发送数据到服务远端
        //send(sock_fd, send_data, strlen(send_data), 0);

        //线程休眠一段时间
        
    
}

static void StaHandler(void)
{
    osThreadAttr_t attr;
    attr.name = "StaTask";
    attr.attr_bits = 0U;
    attr.cb_mem = NULL;
    attr.cb_size = 0U;
    attr.stack_mem = NULL;
    attr.stack_size = 2048;
    attr.priority = 27;
    if (osThreadNew((osThreadFunc_t)StaTask, NULL, &attr) == NULL) {
        printf("StaHandler:create task fail!\r\n");
    }
}*/

static void TcpClientTask(void)
{
    int fd = new_fd[client_no-1];
    int h,t,mq5g,mq7g;//安全帽传来的数据变量
    for(int i=0;;i++)
    {
        ssize_t ret;
        if ((ret = recv(fd, recvbuf[fd], sizeof(recvbuf[fd]), 0)) == -1)
        {
            printf("recv error \r\n");
        }
        printf("recv :%s\r\n", recvbuf[fd]);
        printf("第%d次啦\n",i);
        sscanf(recvbuf[fd],"H:%dT:%dmq5:%dmq7:%d",&h,&t,&mq5g,&mq7g);
        if(mq5g>10)
        {
            UartWrite(WIFI_IOT_UART_IDX_1, (unsigned char *)uart_CO, strlen(uart_CO)); 
            flag = 1;
            sleep(5);
        }
        else
        {
            flag = 0;
        }
        sleep(2);
        
    }
    closesocket(fd);
}

static void TcpClientHandler(void)
{
    osThreadAttr_t attr;
    attr.name = "TcpClientTask";
    attr.attr_bits = 0U;
    attr.cb_mem = NULL;
    attr.cb_size = 0U;
    attr.stack_mem = NULL;
    attr.stack_size = 2048;
    attr.priority = 28+client_no;
    if (osThreadNew((osThreadFunc_t)TcpClientTask, NULL, &attr) == NULL) {
        printf("HotspotStaJoin:create task fail!\r\n");
    }
}

static void HotspotStaJoinTask(void)
{
    static char macAddress[32] = {0};
    StationInfo stainfo[WIFI_MAX_STA_NUM] = {0};
    StationInfo *sta_list_node = NULL;
    unsigned int size = WIFI_MAX_STA_NUM;
    device_no++;
    error = GetStationList(stainfo, &size);
    if (error != WIFI_SUCCESS) {
        printf("HotspotStaJoin:get list fail, error is %d.\r\n", error);
        return;
    }
    sta_list_node = stainfo;
    for (uint32_t i = 0; i < size; i++, sta_list_node++) {
    unsigned char* mac = sta_list_node->macAddress;
    snprintf(macAddress, sizeof(macAddress), "%02X:%02X:%02X:%02X:%02X:%02X", mac[0], mac[1], mac[2], mac[3], mac[4], mac[5]);
    printf("HotspotSta[%d]: macAddress=%s.\r\n",i, macAddress);
    }
    g_apEnableSuccess++;
}

static void OnHotspotStaJoinHandler(StationInfo *info)
{
    if (info == NULL) {
    printf("HotspotStaJoin:info is null.\r\n");
    } 
    else {
        printf("New Sta Join\n");
        osThreadAttr_t attr;
        attr.name = "HotspotStaJoinTask";
        attr.attr_bits = 0U;
        attr.cb_mem = NULL;
        attr.cb_size = 0U;
        attr.stack_mem = NULL;
        attr.stack_size = 2048;
        attr.priority = 24;
        if (osThreadNew((osThreadFunc_t)HotspotStaJoinTask, NULL, &attr) == NULL) {
            printf("HotspotStaJoin:create task fail!\r\n");
        }
    }
    return;
}

static void OnHotspotStaLeaveHandler(StationInfo *info)
{
    if (info == NULL) {
        printf("HotspotStaLeave:info is null.\r\n");
    } 
    else {
        device_no--;
        static char macAddress[32] = {0};
        unsigned char* mac = info->macAddress;
        snprintf(macAddress, sizeof(macAddress), "%02X:%02X:%02X:%02X:%02X:%02X", mac[0], mac[1], mac[2], mac[3], mac[4], mac[5]);
        printf("HotspotStaLeave: macAddress=%s, reason=%d.\r\n", macAddress, info->disconnectedReason);
        g_apEnableSuccess--;
    }
    return;
}

static void OnHotspotStateChangedHandler(int state)
{
    printf("HotspotStateChanged:state is %d.\r\n", state);
    if (state == WIFI_HOTSPOT_ACTIVE) {
        printf("wifi hotspot active.\r\n");
    } else {
        printf("wifi hotspot noactive.\r\n");
    }
}

static void TCPServerDemo(void)
{
	osThreadAttr_t attr;

	attr.name = "TCPServerTask";
	attr.attr_bits = 0U;
	attr.cb_mem = NULL;
	attr.cb_size = 0U;
	attr.stack_mem = NULL;
	attr.stack_size = 10240;
	attr.priority = osPriorityNormal;

	if (osThreadNew((osThreadFunc_t)TCPServerTask, NULL, &attr) == NULL)
	{
		printf("[TCPServerDemo] Falied to create TCPServerTask!\n");
	}
}

APP_FEATURE_INIT(TCPServerDemo);
